{% extends "dashboard_base.html" %}

{% block title %}Tableau de bord - EasyInvoice{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
    :root {
        --dash-purple: #6A1B9A; /* logo purple */
        --dash-green: #00C776;  /* logo green */
    }

    /* Header */
    .page-header {
        margin-bottom: 1.25rem;
    }
    .page-title {
        font-weight: 800;
        margin: 0;
        letter-spacing: 0.2px;
    }
    .page-subtitle {
        color: var(--text-secondary);
        margin-top: 0.25rem;
    }
    /* Embellished title */
    .brand-title { position: relative; display: inline-block; letter-spacing: 1px; }
    .brand-title::after { content: ''; display: block; height: 8px; width: 180px; max-width: 80%; margin-top: 10px; border-radius: 999px; background: linear-gradient(90deg, var(--dash-purple), var(--dash-green)); }
    .brand-purple { color: var(--dash-purple); text-shadow: 0 2px 8px rgba(106,27,154,.15); }
    .brand-green { color: var(--dash-green); text-shadow: 0 2px 8px rgba(0,199,118,.18); }
    .page-title.brand-title { font-size: 2.25rem; }

    /* KPI Cards */
    .kpi-card {
        position: relative;
        border: none;
        border-radius: 14px;
        background: white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        overflow: hidden;
        transition: transform .15s ease, box-shadow .2s ease;
    }
    .kpi-card::before {
        content: '';
        position: absolute;
        inset: 0 auto 0 0;
        width: 5px;
        background: linear-gradient(180deg, var(--dash-purple), var(--dash-green));
    }
    .kpi-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 18px rgba(0,0,0,0.08);
    }
    .kpi-icon {
        width: 42px; height: 42px;
        display: inline-flex; align-items: center; justify-content: center;
        border-radius: 10px;
        background: linear-gradient(135deg, rgba(106,27,154,.12), rgba(0,199,118,.10));
        color: var(--dash-purple);
    }
    .kpi-label { color: var(--text-secondary); font-size: .85rem; font-weight: 600; }
    .kpi-value { font-weight: 800; font-size: 2rem; letter-spacing: .3px; }
    .kpi-value.small { font-size: 1.6rem; }

    /* Quick actions */
    .quick-actions .btn {
        border-radius: 10px;
        font-weight: 600;
        padding: .75rem 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        transition: transform .15s ease, box-shadow .2s ease;
    }
    .quick-actions .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.08); }
    .btn-purple { background: var(--dash-purple); color: #fff; border: none; }
    .btn-green  { background: var(--dash-green); color: #fff; border: none; }
    .btn-outline-purple { border: 2px solid var(--dash-purple); color: var(--dash-purple); background: #fff; }
    .btn-outline-purple:hover { background: rgba(106,27,154,.08); }

    /* Table */
    .table-container { background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,.05); }
    .table thead { background: #f8fafc; }
    .table-hover tbody tr:hover { background: #fbfbff; }

    /* Badges status keep existing classes, ensure bold */
    .badge { font-weight: 700; }

    @media (max-width: 768px) {
        .kpi-value { font-size: 1.6rem; }
        .page-title.brand-title { font-size: 1.9rem; }
        .brand-title::after { height: 6px; width: 140px; }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title brand-title"><span class="brand-purple">V</span><span class="brand-green">IEW</span></h1>
    
</div>

<!-- KPIs -->
<div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
        <div class="card kpi-card">
            <div class="card-body d-flex align-items-center justify-content-between">
                <div>
                    <div class="kpi-label">Total Factures</div>
                    <div class="kpi-value" data-countup="{{ total_invoices|default:0 }}">0</div>
                </div>
                <div class="kpi-icon"><i class="fas fa-file-invoice"></i></div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card kpi-card">
            <div class="card-body d-flex align-items-center justify-content-between">
                <div>
                    <div class="kpi-label">Payées</div>
                    <div class="kpi-value" style="color: var(--dash-green);" data-countup="{{ paid_invoices|default:0 }}">0</div>
                </div>
                <div class="kpi-icon" style="color: var(--dash-green);"><i class="fas fa-check-circle"></i></div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card kpi-card">
            <div class="card-body d-flex align-items-center justify-content-between">
                <div>
                    <div class="kpi-label">En attente</div>
                    <div class="kpi-value small" style="color: #F59E0B;" data-countup="{{ pending_invoices|default:0 }}">0</div>
                </div>
                <div class="kpi-icon" style="color:#F59E0B;"><i class="fas fa-clock"></i></div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card kpi-card">
            <div class="card-body d-flex align-items-center justify-content-between">
                <div>
                    <div class="kpi-label">En retard</div>
                    <div class="kpi-value small" style="color:#EF4444;" data-countup="{{ overdue_invoices|default:0 }}">0</div>
                </div>
                <div class="kpi-icon" style="color:#EF4444;"><i class="fas fa-exclamation-triangle"></i></div>
            </div>
        </div>
    </div>
</div>

<!-- Revenus / En attente -->
<div class="row g-3 mb-4">
    <div class="col-md-6">
        <div class="card kpi-card">
            <div class="card-body d-flex align-items-center justify-content-between">
                <div>
                    <div class="kpi-label">Revenus totaux (payés)</div>
                    <div class="kpi-value" style="color: var(--dash-green);" data-countup-decimal="{{ total_revenue|default:0 }}">0</div>
                </div>
                <div class="kpi-icon" style="color: var(--dash-green);"><i class="fas fa-euro-sign"></i></div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card kpi-card">
            <div class="card-body d-flex align-items-center justify-content-between">
                <div>
                    <div class="kpi-label">En attente de paiement</div>
                    <div class="kpi-value" style="color:#F59E0B;" data-countup-decimal="{{ pending_amount|default:0 }}">0</div>
                </div>
                <div class="kpi-icon" style="color:#F59E0B;"><i class="fas fa-hourglass-half"></i></div>
            </div>
        </div>
    </div>
</div>

<!-- Quick actions -->
<div class="quick-actions d-grid gap-2 gap-md-3 mb-4" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
    <a href="{% url 'CORE:generate_invoice' %}" class="btn btn-green"><i class="fas fa-plus-circle me-2"></i> Nouvelle facture</a>
    <a href="{% url 'CORE:invoice_list' %}" class="btn btn-purple"><i class="fas fa-file-invoice me-2"></i> Voir toutes les factures</a>
    <a href="{% url 'CORE:client_list' %}" class="btn btn-outline-purple"><i class="fas fa-users me-2"></i> Gérer les clients</a>
</div>

<!-- Dernières factures -->
<div class="table-container">
    <div class="p-3 d-flex justify-content-between align-items-center">
        <h2 class="h5 m-0" style="font-weight: 700;">Dernières factures</h2>
        <a href="{% url 'CORE:invoice_list' %}" class="btn btn-sm btn-outline-purple">Voir tout</a>
    </div>
    <div class="table-responsive">
        {% if invoices %}
        <table class="table table-hover align-middle m-0">
            <thead>
                <tr>
                    <th>Numéro</th>
                    <th>Client</th>
                    <th>Date</th>
                    <th class="text-end">Montant</th>
                    <th>Statut</th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for invoice in invoices %}
                <tr>
                    <td><strong>{{ invoice.invoice_number }}</strong></td>
                    <td>{{ invoice.to_name }}</td>
                    <td>{{ invoice.invoice_date|date:"d/m/Y" }}</td>
                    <td class="text-end"><strong>{{ invoice.total|floatformat:2 }} €</strong></td>
                    <td>
                        <span class="badge {{ invoice.get_status_badge_class }}">
                            {{ invoice.get_status_display }}
                        </span>
                    </td>
                    <td class="text-end">
                        <a href="{% url 'CORE:invoice_detail' invoice.id %}" class="btn btn-sm btn-outline-purple"><i class="fas fa-eye"></i></a>
                        <a href="{% url 'CORE:invoice_download_pdf' invoice.id %}" class="btn btn-sm btn-green"><i class="fas fa-download"></i></a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
            <p class="text-muted mb-3">Aucune facture pour le moment.</p>
            <a href="{% url 'CORE:generate_invoice' %}" class="btn btn-green">
                <i class="fas fa-plus-circle me-2"></i>
                Créer votre première facture
            </a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
    // Simple count-up animation
    function animateCount(el, target, isMoney) {
        const duration = 900;
        const start = 0;
        const startTime = performance.now();
        function step(now) {
            const p = Math.min(1, (now - startTime) / duration);
            const value = start + (target - start) * p;
            el.textContent = isMoney ? value.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : Math.round(value);
            if (p < 1) requestAnimationFrame(step);
        }
        requestAnimationFrame(step);
    }
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('[data-countup]').forEach(el => {
            const v = parseFloat(el.getAttribute('data-countup')) || 0;
            animateCount(el, v, false);
        });
        document.querySelectorAll('[data-countup-decimal]').forEach(el => {
            const v = parseFloat(el.getAttribute('data-countup-decimal')) || 0;
            animateCount(el, v, true);
        });
    });
</script>
{% endblock %}
