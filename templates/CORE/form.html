{% extends "dashboard_base.html" %}
{% load static %}

{% block title %}Créer une facture - EasyInvoice{% endblock %}

{% block extra_css %}
{{ block.super }}
<script src="https://unpkg.com/htmx.org@1.9.12"></script>
<style>
    :root {
        --form-purple: #6A1B9A; /* logo purple */
        --form-green: #00C776;  /* logo green */
    }
    .section-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--border-color);
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        transition: box-shadow 0.2s ease;
    }
    
    .section-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    .section-card-title {
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 1.5rem;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #f3f4f6;
    }
    
    .section-card-title i {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, rgba(106, 27, 154, 0.10), rgba(106, 27, 154, 0.05));
        color: var(--form-purple);
        border-radius: 8px;
        font-size: 1rem;
    }

    /* Badges de section */
    .section-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        font-weight: 700;
        border-radius: 50%;
        color: white;
        background: var(--form-purple);
        font-size: 0.9rem;
    }
    .bg-green-tint .section-badge { background: var(--form-green); }

    /* Chips montants */
    .amount-chips .chip {
        background: white;
        border: 1px solid rgba(106,27,154,0.18);
        padding: 0.25rem 0.6rem;
        border-radius: 999px;
        font-size: 0.85rem;
        color: var(--text-primary);
    }
    .amount-chips .chip-total {
        border-color: rgba(0,199,118,0.25);
    }
    .amount-chips .chip-total strong { color: var(--form-green); }

    /* Barre de progression */
    .form-progress {
        position: sticky;
        top: 0;
        height: 6px;
        z-index: 5;
        background: #eef2ff;
        border-radius: 999px;
        overflow: hidden;
        margin: 0.75rem 0 1rem 0;
    }
    .form-progress-inner {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, var(--form-purple), var(--form-green));
        transition: width 0.2s ease;
    }
    
    /* Tinted section backgrounds (brand colors) */
    .bg-purple-tint {
        background: linear-gradient(180deg, rgba(106,27,154,0.06) 0%, rgba(106,27,154,0.03) 100%);
        border-color: rgba(106,27,154,0.18);
    }
    .bg-purple-tint .section-card-title { border-bottom-color: rgba(106,27,154,0.2); }

    .bg-green-tint {
        background: linear-gradient(180deg, rgba(0,199,118,0.07) 0%, rgba(0,199,118,0.03) 100%);
        border-color: rgba(0,199,118,0.2);
    }
    .bg-green-tint .section-card-title { border-bottom-color: rgba(0,199,118,0.22); }
    
    .item-row {
        background: #f8fafc;
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 0.75rem;
        border: 1px solid #e2e8f0;
        transition: all 0.2s ease;
        position: relative;
    }
    
    .item-row:hover {
        background: white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        border-color: #cbd5e1;
    }
    
    /* Inputs améliorés */
    .form-control, .form-select {
        border-radius: 8px;
        border: 1.5px solid #e5e7eb;
        transition: all 0.2s ease;
        padding: 0.65rem 0.9rem;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: var(--form-purple);
        box-shadow: 0 0 0 3px rgba(106,27,154,0.12);
        outline: none;
    }
    
    .form-control:hover:not(:focus), .form-select:hover:not(:focus) {
        border-color: #cbd5e1;
    }
    
    .form-label {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
        letter-spacing: 0.01em;
    }
    
    /* Textarea */
    textarea.form-control {
        resize: vertical;
        min-height: 100px;
    }
    
    /* Bouton "Ajouter ligne" */
    .btn-add-item {
        border: 2px dashed #cbd5e1;
        background: #fafbfc;
        color: var(--form-purple);
        font-weight: 600;
        transition: all 0.25s ease;
        min-height: 52px;
        border-radius: 10px;
        font-size: 0.95rem;
    }
    
    .btn-add-item:hover, .btn-add-item:active {
        border-color: var(--form-purple);
        border-style: solid;
        background: rgba(106,27,154,0.06);
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(106,27,154,0.18);
    }
    
    .btn-add-item i {
        transition: transform 0.2s ease;
    }
    
    .btn-add-item:hover i {
        transform: scale(1.1);
    }
    
    /* Bouton principal "Créer facture" */
    .btn-success.btn-lg {
        background: var(--form-green);
        border-color: var(--form-green);
        border-radius: 10px;
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(0, 199, 118, 0.25);
        transition: all 0.2s ease;
    }
    
    .btn-success.btn-lg:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 199, 118, 0.35);
    }
    
    /* Badges */
    .badge-success {
        background: var(--form-green);
        padding: 0.375rem 0.75rem;
        font-weight: 600;
        border-radius: 6px;
    }
    
    /* Checkboxes */
    .form-check-input {
        width: 1.15rem;
        height: 1.15rem;
        border: 1.5px solid #cbd5e1;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .form-check-input:checked {
        background-color: var(--form-purple);
        border-color: var(--form-purple);
    }
    
    .form-check-input:hover {
        border-color: var(--form-purple);
    }
    
    .form-check-label {
        cursor: pointer;
        font-weight: 500;
        margin-left: 0.5rem;
    }
    
    /* Header de page */
    .page-header {
        margin-bottom: 2rem;
    }
    
    .page-title {
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
        font-size: 1.875rem;
    }
    
    .page-subtitle {
        color: var(--text-secondary);
        font-size: 1rem;
    }
    
    /* Alerts améliorés */
    .alert {
        border-radius: 10px;
        border-left: 4px solid;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    
    .alert-warning {
        background: #fffbeb;
        border-left-color: #f59e0b;
        color: #92400e;
    }
    
    .alert-danger {
        background: #fef2f2;
        border-left-color: #ef4444;
        color: #991b1b;
    }
    
    /* Small text helper */
    small.text-muted {
        font-size: 0.85rem;
        color: #6b7280;
    }
    
    /* Bouton supprimer item */
    .btn-outline-danger {
        border-color: #fecaca;
        color: #dc2626;
        transition: all 0.2s ease;
    }
    
    .btn-outline-danger:hover {
        background: #fee2e2;
        border-color: #dc2626;
        color: #991b1b;
    }
    
    /* Sticky mobile btn container */
    .sticky-mobile-btn {
        margin-top: 2rem;
    }
    
    .sticky-mobile-btn small {
        font-size: 0.875rem;
        color: #6b7280;
    }
    
    /* Mobile optimization pour le formulaire */
    @media (max-width: 991px) {
        /* Activer flexbox sur le parent pour réorganiser */
        form > .row {
            display: flex;
            flex-direction: column;
        }
        
        /* NOUVEL ORDRE MOBILE (du plus important au moins) :
           1. Dates (order: 1)
           2. TVA (order: 2)
           3. Informations client (order: 3)
           4. Lignes de facture (order: 4)
           5. Conditions de paiement (order: 5)
           6. Vos informations - pré-remplies (order: 6)
           7. Bouton Créer (order: 999)
        */
        
        /* Sidebar : Dates et TVA en premier */
        .col-lg-4 {
            display: flex;
            flex-direction: column;
        }
        
        .col-lg-4 .section-card:nth-child(1) {
            order: 1; /* Dates */
        }
        
        .col-lg-4 .section-card:nth-child(2) {
            order: 2; /* TVA */
        }
        
        .col-lg-4 .sticky-mobile-btn {
            order: 999; /* Bouton en dernier */
        }
        
        /* Contenu principal : réorganiser les sections */
        .col-lg-8 {
            display: flex;
            flex-direction: column;
        }
        
        .col-lg-8 .section-card:nth-child(1) {
            order: 6; /* Vos infos (pré-remplies) en dernier */
        }
        
        .col-lg-8 .section-card:nth-child(2) {
            order: 3; /* Info client en 3ème */
        }
        
        .col-lg-8 .section-card:nth-child(3) {
            order: 4; /* Lignes facture en 4ème */
        }
        
        .col-lg-8 .section-card:nth-child(4) {
            order: 5; /* Conditions paiement en 5ème */
        }
    }
    
    @media (max-width: 768px) {
        .section-card {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .section-card-title {
            font-size: 1rem;
            margin-bottom: 1rem;
        }
        
        .form-label {
            font-size: 0.9rem;
            margin-bottom: 0.4rem;
        }
        
        /* Espacement entre les champs */
        .mb-3 {
            margin-bottom: 1rem !important;
        }
        
        /* Champs de date empilés sur mobile */
        .row .col-md-6,
        .row .col-md-4,
        .row .col-md-3 {
            margin-bottom: 0.75rem;
        }
        
        /* Bouton à la fin du formulaire (pas flottant) */
        .sticky-mobile-btn {
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .sticky-mobile-btn .btn {
            font-size: 1.1rem;
            padding: 1rem 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        /* Item rows plus compactes */
        .item-row {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        /* Textarea plus petit sur mobile */
        textarea.form-control {
            min-height: 80px;
        }
        
        /* Bouton "Ajouter ligne" plus visible */
        .btn-add-item {
            font-size: 1rem;
            padding: 0.875rem;
        }
        
        /* Alert plus compact */
        .alert {
            padding: 0.75rem;
            font-size: 0.9rem;
        }
        
        /* Page header plus compact */
        .page-header {
            margin-bottom: 1rem;
        }
        
        .page-title {
            font-size: 1.5rem;
        }
        
        .page-subtitle {
            font-size: 0.85rem;
        }
    }
    
    /* Très petit écran */
    @media (max-width: 576px) {
        .section-card {
            padding: 0.75rem;
        }
        
        .section-card-title {
            font-size: 0.95rem;
        }
        
        .form-label {
            font-size: 0.85rem;
        }
        
        .btn-add-item {
            font-size: 0.95rem;
        }
    }
    
    /* Desktop: plus d'espace */
    @media (min-width: 769px) {
        .section-card {
            padding: 2rem;
        }
    }
    
    /* Reset order pour desktop */
    @media (min-width: 992px) {
        .col-lg-8,
        .col-lg-4,
        .sticky-mobile-btn {
            order: 0;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header mb-4">
    <h1 class="page-title">Créer une facture</h1>
    <p class="page-subtitle">Remplissez les informations pour générer votre facture PDF</p>
</div>

<!-- Progress bar (remplit au scroll du formulaire) -->
<div class="form-progress" aria-hidden="true">
    <div class="form-progress-inner" id="formProgressBar"></div>
    <div class="form-progress-bg"></div>
    <div class="form-progress-grid"></div>
    <!-- éléments décoratifs facultatifs -->
    
</div>

{% if not weasyprint_available %}
<div class="alert alert-warning mb-4" role="alert">
    <i class="fas fa-exclamation-triangle me-2"></i>
    <strong>Attention:</strong> WeasyPrint n'est pas installé. Installez-le avec: <code>pip install WeasyPrint</code>
</div>
{% endif %}

<form method="post">
    {% csrf_token %}
    
    {% if form.non_field_errors %}
    <div class="alert alert-danger mb-4">
        <i class="fas fa-exclamation-circle me-2"></i>
        {{ form.non_field_errors }}
    </div>
    {% endif %}
    
    <div class="row">
        <div class="col-lg-8">
            <!-- Informations de l'émetteur -->
            <div class="section-card bg-purple-tint">
                <h3 class="section-card-title">
                    <span class="section-badge">6</span>
                    <i class="fas fa-building"></i>
                    Vos informations
                </h3>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">{{ form.from_name.label }}</label>
                        {{ form.from_name }}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">{{ form.invoice_number.label }}</label>
                        {{ form.invoice_number }}
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">{{ form.from_address.label }}</label>
                    {{ form.from_address }}
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">{{ form.from_city.label }}</label>
                        {{ form.from_city }}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">{{ form.from_email.label }}</label>
                        {{ form.from_email }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">{{ form.siret.label }}</label>
                        {{ form.siret }}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">{{ form.rcs.label }}</label>
                        {{ form.rcs }}
                    </div>
                </div>
                <div class="form-check">
                    {{ form.is_ei }}
                    <label class="form-check-label">{{ form.is_ei.label }}</label>
                </div>
            </div>
            
            <!-- Informations du client -->
            <div class="section-card bg-purple-tint">
                <h3 class="section-card-title">
                    <span class="section-badge">3</span>
                    <i class="fas fa-user"></i>
                    Informations client
                </h3>
                <div class="mb-3">
                    <label class="form-label">{{ form.to_name.label }}</label>
                    {{ form.to_name }}
                </div>
                <div class="mb-3">
                    <label class="form-label">{{ form.to_address.label }}</label>
                    {{ form.to_address }}
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">{{ form.to_city.label }}</label>
                        {{ form.to_city }}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">{{ form.to_email.label }}</label>
                        {{ form.to_email }}
                    </div>
                </div>
            </div>
            
            <!-- Lignes de facture -->
            <div class="section-card bg-green-tint">
                <div class="section-card-title" style="justify-content: space-between;">
                    <div class="title-left d-flex align-items-center gap-2">
                        <span class="section-badge">4</span>
                        <i class="fas fa-list"></i>
                        <span>Lignes de facture</span>
                    </div>
                    <div class="title-right amount-chips d-flex align-items-center gap-2">
                        <span class="chip chip-subtotal">HT: <strong id="chip-subtotal">0,00 €</strong></span>
                        <span class="chip chip-vat">TVA: <strong id="chip-vat">0,00 €</strong></span>
                        <span class="chip chip-total">TTC: <strong id="chip-total">0,00 €</strong></span>
                    </div>
                </div>
                {% if items_formset.non_form_errors %}
                <div class="alert alert-danger">{{ items_formset.non_form_errors }}</div>
                {% endif %}
                
                <div id="items-container">
                    <input type="hidden" name="items-TOTAL_FORMS" id="id_items-TOTAL_FORMS" value="{{ items_formset.total_form_count }}">
                    <input type="hidden" name="items-INITIAL_FORMS" value="0">
                    <input type="hidden" name="items-MIN_NUM_FORMS" value="0">
                    <input type="hidden" name="items-MAX_NUM_FORMS" value="1000">

                    {% for form_item in items_formset.forms %}
                        {% if form_item.errors %}
                        <div class="alert alert-danger">{{ form_item.errors }}</div>
                        {% endif %}
                        {% include 'CORE/_item_row.html' with form=form_item index=forloop.counter0 %}
                    {% endfor %}
                </div>
                
                <button type="button"
                        class="btn btn-add-item w-100"
                        hx-post="{% url 'CORE:add_item_row' %}"
                        hx-include="#id_items-TOTAL_FORMS"
                        hx-target="#items-container"
                        hx-swap="beforeend">
                    <i class="fas fa-plus-circle me-2"></i>
                    Ajouter une ligne
                </button>
            </div>
            
            <!-- Conditions de paiement -->
            <div class="section-card bg-purple-tint">
                <h3 class="section-card-title">
                    <span class="section-badge">5</span>
                    <i class="fas fa-money-check-alt"></i>
                    Conditions de paiement
                </h3>
                <div class="mb-3">
                    <label class="form-label">{{ form.payment_terms.label }}</label>
                    {{ form.payment_terms }}
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">{{ form.late_fee_rate.label }}</label>
                        {{ form.late_fee_rate }}
                    </div>
                    <div class="col-md-6 mb-3 d-flex align-items-end">
                        <div class="form-check">
                            {{ form.recovery_fee }}
                            <label class="form-check-label">{{ form.recovery_fee.label }}</label>
                        </div>
                    </div>
                </div>
                <div class="form-check">
                    {{ form.autoliquidation }}
                    <label class="form-check-label">{{ form.autoliquidation.label }}</label>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Dates -->
            <div class="section-card bg-purple-tint">
                <h3 class="section-card-title">
                    <span class="section-badge">1</span>
                    <i class="fas fa-calendar"></i>
                    Dates
                </h3>
                <div class="mb-3">
                    <label class="form-label">{{ form.invoice_date.label }}</label>
                    {{ form.invoice_date }}
                </div>
                <div class="mb-3">
                    <label class="form-label">{{ form.service_date_start.label }}</label>
                    {{ form.service_date_start }}
                </div>
                <div class="mb-3">
                    <label class="form-label">{{ form.service_date_end.label }}</label>
                    {{ form.service_date_end }}
                </div>
                <div class="mb-3">
                    <label class="form-label">{{ form.due_date.label }}</label>
                    {{ form.due_date }}
                </div>
            </div>
            
            <!-- TVA -->
            <div class="section-card bg-green-tint">
                <h3 class="section-card-title">
                    <span class="section-badge">2</span>
                    <i class="fas fa-percentage"></i>
                    TVA
                </h3>
                <div class="mb-3">
                    <div class="form-check">
                        {{ form.is_vat_exempt }}
                        <label class="form-check-label">{{ form.is_vat_exempt.label }}</label>
                    </div>
                    <small class="text-muted">Si coché, la TVA ne s'applique pas</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">{{ form.vat_rate.label }}</label>
                    {{ form.vat_rate }}
                    <small class="text-muted d-block mt-1">Ignoré si franchise de TVA</small>
                </div>
            </div>
            
            <!-- Bouton de génération -->
            <div class="sticky-mobile-btn">
                <button type="submit" class="btn btn-success btn-lg w-100">
                    <i class="fas fa-check-circle me-2"></i>
                    Créer la facture
                </button>
                <small class="text-muted d-block mt-2 text-center">
                    Vous pourrez télécharger le PDF après la création
                </small>
            </div>
        </div>
    </div>

</form>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
    document.addEventListener('click', function(e) {
        const btn = e.target.closest('[data-action="remove-item"]');
        if (!btn) return;
        const row = btn.closest('.item-row');
        if (!row) return;
        const cb = row.querySelector('input[type="checkbox"]');
        if (cb) cb.checked = true;
        row.style.display = 'none';
        recalcChips();
    });

    function parseNum(v) {
        if (typeof v !== 'string') v = String(v||'');
        v = v.replace(/\s/g,'').replace(',', '.');
        const n = parseFloat(v);
        return isNaN(n) ? 0 : n;
    }

    function formatAmount(n) {
        return n.toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' \u20AC';
    }

    function recalcChips() {
        const container = document.getElementById('items-container');
        if (!container) return;
        const qtys = container.querySelectorAll('input[name$="-quantity"]');
        const prices = container.querySelectorAll('input[name$="-unit_price"]');
        let subtotal = 0;
        const len = Math.max(qtys.length, prices.length);
        for (let i=0; i<len; i++) {
            const q = parseNum(qtys[i]?.value || 0);
            const p = parseNum(prices[i]?.value || 0);
            subtotal += q * p;
        }
        let vatRate = parseNum(document.getElementById('id_vat_rate')?.value || 0);
        const vatExempt = !!document.getElementById('id_is_vat_exempt')?.checked;
        let vat = vatExempt ? 0 : subtotal * (vatRate / 100);
        let total = subtotal + vat;
        const elSub = document.getElementById('chip-subtotal');
        const elVat = document.getElementById('chip-vat');
        const elTot = document.getElementById('chip-total');
        if (elSub) elSub.textContent = formatAmount(subtotal);
        if (elVat) elVat.textContent = formatAmount(vat);
        if (elTot) elTot.textContent = formatAmount(total);
    }

    function bindInputsForChips() {
        const form = document.querySelector('form');
        if (!form) return;
        form.addEventListener('input', (e) => {
            const target = e.target;
            if (!target) return;
            if (target.name?.includes('-quantity') || target.name?.includes('-unit_price') || target.id === 'id_vat_rate' || target.id === 'id_is_vat_exempt') {
                recalcChips();
            }
        });
    }

    // Rebind after HTMX row add
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.target && evt.target.id === 'items-container') {
            recalcChips();
        }
    });

    // Progress bar update on scroll
    function updateProgressBar() {
        const bar = document.getElementById('formProgressBar');
        const form = document.querySelector('form');
        if (!bar || !form) return;
        const start = form.offsetTop;
        const end = form.offsetTop + form.offsetHeight - window.innerHeight;
        const y = window.scrollY;
        let pct = 0;
        if (y <= start) pct = 0; else if (y >= end) pct = 1; else pct = (y - start) / (end - start);
        bar.style.width = (Math.max(0, Math.min(1, pct)) * 100).toFixed(1) + '%';
    }

    window.addEventListener('scroll', updateProgressBar);
    window.addEventListener('resize', updateProgressBar);

    // Init
    document.addEventListener('DOMContentLoaded', () => {
        bindInputsForChips();
        recalcChips();
        updateProgressBar();
    });
</script>
{% endblock %}
