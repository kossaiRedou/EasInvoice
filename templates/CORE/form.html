{% extends "dashboard_base.html" %}
{% load static %}

{% block title %}Créer une facture - EasyInvoice{% endblock %}

{% block extra_css %}
{{ block.super }}
<script src="https://unpkg.com/htmx.org@1.9.12"></script>
<style>
    .section-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--border-color);
    }
    
    .section-card-title {
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 1.5rem;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .section-card-title i {
        color: var(--blue-primary);
    }
    
    .item-row {
        background: var(--bg-page);
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 0.75rem;
        border: 1px solid var(--border-color);
        transition: all 0.2s;
    }
    
    .item-row:hover {
        background: white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .form-control:focus, .form-select:focus {
        border-color: var(--blue-primary);
        box-shadow: 0 0 0 0.2rem rgba(30,144,255,0.15);
    }
    
    .form-label {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
    }
    
    .btn-add-item {
        border: 2px dashed var(--border-color);
        background: transparent;
        color: var(--blue-primary);
        font-weight: 600;
        transition: all 0.2s;
        min-height: 50px;
    }
    
    .btn-add-item:hover, .btn-add-item:active {
        border-color: var(--blue-primary);
        background: rgba(30,144,255,0.05);
    }
    
    .badge-success {
        background: var(--green-accent);
        padding: 0.375rem 0.75rem;
        font-weight: 600;
    }
    
    /* Mobile optimization pour le formulaire */
    @media (max-width: 768px) {
        .section-card {
            padding: 1rem;
            border-radius: 8px;
        }
        
        .section-card-title {
            font-size: 1rem;
            margin-bottom: 1rem;
        }
        
        .form-label {
            font-size: 0.9rem;
        }
        
        /* Champs de date empilés sur mobile */
        .row .col-md-6,
        .row .col-md-4,
        .row .col-md-3 {
            margin-bottom: 1rem;
        }
        
        /* Sticky button sur mobile */
        .sticky-mobile-btn {
            position: sticky;
            bottom: 1rem;
            z-index: 100;
            margin-top: 2rem;
        }
        
        .sticky-mobile-btn .btn {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        /* Item rows plus compactes */
        .item-row {
            padding: 0.75rem;
        }
        
        /* Textarea plus petit sur mobile */
        textarea.form-control {
            min-height: 80px;
        }
    }
    
    /* Desktop: plus d'espace */
    @media (min-width: 769px) {
        .section-card {
            padding: 2rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header mb-4">
    <h1 class="page-title">Créer une facture</h1>
    <p class="page-subtitle">Remplissez les informations pour générer votre facture PDF</p>
</div>

{% if not weasyprint_available %}
<div class="alert alert-warning mb-4" role="alert">
    <i class="fas fa-exclamation-triangle me-2"></i>
    <strong>Attention:</strong> WeasyPrint n'est pas installé. Installez-le avec: <code>pip install WeasyPrint</code>
</div>
{% endif %}

<form method="post">
    {% csrf_token %}
    
    {% if form.non_field_errors %}
    <div class="alert alert-danger mb-4">
        <i class="fas fa-exclamation-circle me-2"></i>
        {{ form.non_field_errors }}
    </div>
    {% endif %}
    
    <div class="row">
        <div class="col-lg-8">
            <!-- Informations de l'émetteur -->
            <div class="section-card">
                <h3 class="section-card-title">
                    <i class="fas fa-building"></i>
                    Vos informations
                </h3>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">{{ form.from_name.label }}</label>
                        {{ form.from_name }}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">{{ form.invoice_number.label }}</label>
                        {{ form.invoice_number }}
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">{{ form.from_address.label }}</label>
                    {{ form.from_address }}
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">{{ form.from_city.label }}</label>
                        {{ form.from_city }}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">{{ form.from_email.label }}</label>
                        {{ form.from_email }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">{{ form.siret.label }}</label>
                        {{ form.siret }}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">{{ form.rcs.label }}</label>
                        {{ form.rcs }}
                    </div>
                </div>
                <div class="form-check">
                    {{ form.is_ei }}
                    <label class="form-check-label">{{ form.is_ei.label }}</label>
                </div>
            </div>
            
            <!-- Informations du client -->
            <div class="section-card">
                <h3 class="section-card-title">
                    <i class="fas fa-user"></i>
                    Informations client
                </h3>
                <div class="mb-3">
                    <label class="form-label">{{ form.to_name.label }}</label>
                    {{ form.to_name }}
                </div>
                <div class="mb-3">
                    <label class="form-label">{{ form.to_address.label }}</label>
                    {{ form.to_address }}
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">{{ form.to_city.label }}</label>
                        {{ form.to_city }}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">{{ form.to_email.label }}</label>
                        {{ form.to_email }}
                    </div>
                </div>
            </div>
            
            <!-- Lignes de facture -->
            <div class="section-card">
                <h3 class="section-card-title">
                    <i class="fas fa-list"></i>
                    Lignes de facture
                </h3>
                {% if items_formset.non_form_errors %}
                <div class="alert alert-danger">{{ items_formset.non_form_errors }}</div>
                {% endif %}
                
                <div id="items-container">
                    <input type="hidden" name="items-TOTAL_FORMS" id="id_items-TOTAL_FORMS" value="{{ items_formset.total_form_count }}">
                    <input type="hidden" name="items-INITIAL_FORMS" value="0">
                    <input type="hidden" name="items-MIN_NUM_FORMS" value="0">
                    <input type="hidden" name="items-MAX_NUM_FORMS" value="1000">

                    {% for form_item in items_formset.forms %}
                        {% if form_item.errors %}
                        <div class="alert alert-danger">{{ form_item.errors }}</div>
                        {% endif %}
                        {% include 'CORE/_item_row.html' with form=form_item index=forloop.counter0 %}
                    {% endfor %}
                </div>
                
                <button type="button"
                        class="btn btn-add-item w-100"
                        hx-post="{% url 'CORE:add_item_row' %}"
                        hx-include="#id_items-TOTAL_FORMS"
                        hx-target="#items-container"
                        hx-swap="beforeend">
                    <i class="fas fa-plus-circle me-2"></i>
                    Ajouter une ligne
                </button>
            </div>
            
            <!-- Conditions de paiement -->
            <div class="section-card">
                <h3 class="section-card-title">
                    <i class="fas fa-money-check-alt"></i>
                    Conditions de paiement
                </h3>
                <div class="mb-3">
                    <label class="form-label">{{ form.payment_terms.label }}</label>
                    {{ form.payment_terms }}
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">{{ form.late_fee_rate.label }}</label>
                        {{ form.late_fee_rate }}
                    </div>
                    <div class="col-md-6 mb-3 d-flex align-items-end">
                        <div class="form-check">
                            {{ form.recovery_fee }}
                            <label class="form-check-label">{{ form.recovery_fee.label }}</label>
                        </div>
                    </div>
                </div>
                <div class="form-check">
                    {{ form.autoliquidation }}
                    <label class="form-check-label">{{ form.autoliquidation.label }}</label>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Dates -->
            <div class="section-card">
                <h3 class="section-card-title">
                    <i class="fas fa-calendar"></i>
                    Dates
                </h3>
                <div class="mb-3">
                    <label class="form-label">{{ form.invoice_date.label }}</label>
                    {{ form.invoice_date }}
                </div>
                <div class="mb-3">
                    <label class="form-label">{{ form.service_date_start.label }}</label>
                    {{ form.service_date_start }}
                </div>
                <div class="mb-3">
                    <label class="form-label">{{ form.service_date_end.label }}</label>
                    {{ form.service_date_end }}
                </div>
                <div class="mb-3">
                    <label class="form-label">{{ form.due_date.label }}</label>
                    {{ form.due_date }}
                </div>
            </div>
            
            <!-- TVA -->
            <div class="section-card">
                <h3 class="section-card-title">
                    <i class="fas fa-percentage"></i>
                    TVA
                </h3>
                <div class="mb-3">
                    <div class="form-check">
                        {{ form.is_vat_exempt }}
                        <label class="form-check-label">{{ form.is_vat_exempt.label }}</label>
                    </div>
                    <small class="text-muted">Si coché, la TVA ne s'applique pas</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">{{ form.vat_rate.label }}</label>
                    {{ form.vat_rate }}
                    <small class="text-muted d-block mt-1">Ignoré si franchise de TVA</small>
                </div>
            </div>
            
            <!-- Bouton de génération -->
            <div class="sticky-mobile-btn">
                <button type="submit" class="btn btn-success btn-lg w-100">
                    <i class="fas fa-check-circle me-2"></i>
                    Créer la facture
                </button>
                <small class="text-muted d-block mt-2 text-center">
                    Vous pourrez télécharger le PDF après la création
                </small>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
    document.addEventListener('click', function(e) {
        const btn = e.target.closest('[data-action="remove-item"]');
        if (!btn) return;
        const row = btn.closest('.item-row');
        if (!row) return;
        const cb = row.querySelector('input[type="checkbox"]');
        if (cb) cb.checked = true;
        row.style.display = 'none';
    });
</script>
{% endblock %}
