<html lang="fr">
  <head>
    <meta charset="utf-8">
    <link href="invoice.css" media="print" rel="stylesheet">
    <title>Facture {{ invoice_number }}</title>
    <meta name="description" content="Facture {{ invoice_number }}">
    <style>
      .ei-badge {
        background: #1ee494;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.7em;
        font-weight: bold;
        display: inline-block;
        margin: 2px 0;
      }
      .addr-label { color: #a9a; text-transform: uppercase; font-size: 9pt; display: block; margin-bottom: 2px; }
      address { line-height: 1.2; margin: 0; }
    </style>
  </head>

  <body>
    <h1>Facture</h1>

    <aside>
      <address id="from">
        <span class="addr-label">Émetteur</span>
        <strong class="company-name">{{ from_name }}</strong><br>
        {{ from_address|linebreaks }}
        {% if from_city %}{{ from_city }}<br>{% endif %}
        {% if from_email %}<span style="color:#555;"> {{ from_email }}</span><br>{% endif %}
        {% if siret %}<strong>SIRET:</strong> {{ siret }}<br>{% endif %}
        {% if rcs %}<strong>RCS:</strong> {{ rcs }}{% endif %}
        {% if is_ei %}<div class="ei-badge">ENTREPRENEUR INDIVIDUEL</div>{% endif %}
      </address>

      <address id="to">
        <span class="addr-label">Destinataire</span>
        <span class="company-name">{{ to_name }}</span><br>
        {{ to_address|linebreaks }}
        {% if to_city %}{{ to_city }}<br>{% endif %}
        {% if to_email %}<span style="color:#555;"> {{ to_email }}</span>{% endif %}
      </address>
    </aside>

    <dl id="informations">
      <dt>Numéro de facture</dt>
      <dd>{{ invoice_number }}</dd>
      <dt>Date d'émission</dt>
      <dd>{{ invoice_date|date:"d/m/Y" }}</dd>
      {% if service_date_start or service_date_end %}
      <dt>Période de prestation</dt>
      <dd>
        {% if service_date_start and service_date_end %}
        Du {{ service_date_start|date:"d/m/Y" }} <br> au {{ service_date_end|date:"d/m/Y" }}
        {% elif service_date_start %}
          À partir du {{ service_date_start|date:"d/m/Y" }}
        {% elif service_date_end %}
          Jusqu'au {{ service_date_end|date:"d/m/Y" }}
        {% endif %}
      </dd>
      {% endif %}
      <dt>Date d'échéance</dt>
      <dd>{{ due_date|date:"d/m/Y" }}</dd>
    </dl>

    <table>
      <thead>
        <tr>
          <th>Description</th>
          <th>Quantité</th>
          <th>Prix unitaire HT</th>
          <th>Total HT</th>
        </tr>
      </thead>
      <tbody>
        {% for item in items %}
        <tr>
          <td>{{ item.description }}</td>
          <td>{{ item.quantity }}</td>
          <td>{{ item.unit_price }} €</td>
          <td>{{ item.line_total|floatformat:2 }} €</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    
    <footer>
      <table id="total">
        <thead>
          <tr>
            <th>Total HT</th>
            <th>TVA ({% if is_vat_exempt %}0{% else %}{{ vat_rate }}{% endif %}%)</th>
            <th>Total TTC</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>{{ subtotal|floatformat:2 }} €</td>
            <td>{{ vat_amount|floatformat:2 }} €</td>
            <td>{{ total|floatformat:2 }} €</td>
          </tr>
        </tbody>
      </table>

      {% if vat_note %}
      <p style="margin-top: 0.5em; font-size: 0.85em;">{{ vat_note }}</p>
      {% endif %}
      
      {% if payment_terms %}
      <p style="margin-top: 0.5em; margin-bottom: 0.3em; font-size: 0.9em;"><strong>Modalités de paiement:</strong></p>
      <p style="margin: 0; font-size: 0.85em;">{{ payment_terms }}</p>
      {% endif %}

      {% if penalties_note %}
      <div style="margin-top: 0.5em; padding: 0.5em; background: #FEF3C7; border-left: 3px solid #F59E0B; border-radius: 4px;">
        <strong style="color: #92400E; font-size: 0.85em;">Pénalités de retard:</strong>
        <p style="margin: 0.3em 0 0 0; color: #92400E; font-size: 0.8em;">{{ penalties_note }}</p>
      </div>
      {% endif %}

      {% if recovery_note %}
      <p style="margin-top: 0.5em; color: #6B7280; font-size: 0.8em;">{{ recovery_note }}</p>
      {% endif %}

      {% if autoliquidation %}
      <p style="margin-top: 0.5em; font-size: 0.85em;"><strong>Autoliquidation</strong></p>
      {% endif %}
    </footer>

  </body>
</html>
